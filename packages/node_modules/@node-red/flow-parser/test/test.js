const assert = require("assert");
const fp = require("../lib/index.js");

const fs = require("fs");


const original = JSON.parse(fs.readFileSync(__dirname+"/resources/flow.json","utf-8"));
const flowSet = fp.parseFlow(original);
const generated = flowSet.export();


const knownIds = original.map(n => n.id).sort();

const walkedNodes = {};
flowSet.walk(n => {
    assert(!walkedNodes[n.id],"Walk visited same node id twice: "+n.id+" "+n.type)
    walkedNodes[n.id] = n;
});

const generatedIds = Object.keys(walkedNodes)
generatedIds.sort();

for (var i=0;i<Math.max(knownIds.length,generatedIds.length);i++) {
    assert.strictEqual(knownIds[i],generatedIds[i])
}

assert(knownIds.length === generatedIds.length,"walk did not visit enough nodes")


original.sort(function(A,B) { return A.id.localeCompare(B.id)})
generated.sort(function(A,B) { return A.id.localeCompare(B.id)})

function mangle(obj) {
    var result = [];
    for (var i in obj) {
        result.push(i+":"+JSON.stringify(obj[i]))
    }
    result.sort();
    return result;
}
const originalSorted = JSON.stringify(original.map(v => mangle(v)),"",2);
const generatedSorted = JSON.stringify(generated.map(v => mangle(v)),"",2);

assert(originalSorted === generatedSorted, "generated flow does not match source flow")
// fs.writeFileSync("/tmp/flow-A.json",JSON.stringify(original,"",2));
// fs.writeFileSync("/tmp/flow-B.json",JSON.stringify(generated,"",2));
